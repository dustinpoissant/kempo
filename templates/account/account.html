<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta
		name="viewport"
		content="width=device-width, initial-scale=1.0"
	>
	<link rel="icon" type="image/png" sizes="48x48" href="../media/icon48.png">
	<link rel="manifest" href="../manifest.json" />
	<title>My Account</title>
	<link rel="stylesheet" href="../kempo-css/kempo.min.css">
	<script>window.litDisableBundleWarning = true;</script>
</head>
<body>
	<k-import src="../nav-1.inc.html"></k-import>
	<main class="p">
		<div style="max-width: 600px; margin: 0 auto;">
			<h2>My Account</h2>
			<div id="loading">Loading...</div>
			<div id="accountInfo" style="display: none;">
				<div class="mb">
					<strong>Name:</strong> <span id="userName"></span>
				</div>
				<div class="mb">
					<strong>Email:</strong> <span id="userEmail"></span>
				</div>
				<div class="mb">
					<strong>Email Verified:</strong> <span id="emailVerified"></span>
				</div>
				<div class="mb">
					<strong>Member Since:</strong> <span id="createdAt"></span>
				</div>

				<k-dialog id="changePasswordDialog">
					<h5 slot="title" class="pyh px m0">Change Password</h5>
					<form id="changePasswordForm" class="p">
						<div class="mb">
							<label for="currentPassword" class="d-b mb-sm">Current Password</label>
							<input type="password" id="currentPassword" required class="w-full p-sm br">
						</div>
						<div class="mb">
							<label for="newPassword" class="d-b mb-sm">New Password</label>
							<input type="password" id="newPassword" required minlength="8" class="w-full p-sm br">
						</div>
						<div class="mb">
							<label for="confirmPassword" class="d-b mb-sm">Confirm New Password</label>
							<input type="password" id="confirmPassword" required minlength="8" class="w-full p-sm br">
						</div>
						<div id="passwordError" class="mb c-error" style="display: none;"></div>
						<div id="passwordSuccess" class="mb c-success" style="display: none;"></div>
						<button type="submit" class="p-sm br">Change Password</button>
					</form>
				</k-dialog>

				<div class="mt-lg">
					<k-role requires="contributor">
						<a href="/kempo" class="btn primary">Admin Panel</a>
					</k-role>
					<button id="changePasswordBtn" class="btn">Change Password</button>
					<button id="logoutBtn" class="btn danger">Logout</button>
				</div>
			</div>
		</div>
	</main>
	<script src="https://cdn.jsdelivr.net/npm/kempo-ui@0.0.42/dist/components/Import.js" type="module"></script>
	<script type="module">
		import Dialog from '/kempo-ui/components/Dialog.js';
		import '../kempo/components/Role.js';
		import { getSession, logout } from '../kempo/auth.js';

		const loadingDiv = document.getElementById('loading');
		const accountInfoDiv = document.getElementById('accountInfo');
		const changePasswordBtn = document.getElementById('changePasswordBtn');
		const changePasswordDialog = document.getElementById('changePasswordDialog');
		const logoutBtn = document.getElementById('logoutBtn');

		async function loadAccount() {
			let timeoutId;
			try {
				// Promise that rejects after 5 seconds
				const timeoutPromise = new Promise((_, reject) => {
					timeoutId = setTimeout(() => reject(new Error('Session request timed out. Please refresh.')), 5000);
				});
				const session = await Promise.race([getSession(), timeoutPromise]);

				if(!session || !session.user) {
					loadingDiv.textContent = 'Session expired. Please log in again.';
					setTimeout(() => {
						window.location.href = '/account/login';
					}, 1500);
					return;
				}

				document.getElementById('userName').textContent = session.user.name;
				document.getElementById('userEmail').textContent = session.user.email;
				document.getElementById('emailVerified').textContent = session.user.emailVerified ? 'Yes' : 'No';
				document.getElementById('createdAt').textContent = new Date(session.user.createdAt).toLocaleDateString();

				loadingDiv.style.display = 'none';
				accountInfoDiv.style.display = 'block';
			} catch(error) {
				loadingDiv.textContent = error.message || 'Failed to load account info. Please refresh.';
				loadingDiv.style.color = 'red';
				setTimeout(() => {
					window.location.href = '/account/login';
				}, 2000);
			} finally {
				clearTimeout(timeoutId);
			}
		}

		changePasswordBtn.addEventListener('click', () => {
			changePasswordDialog.open();
		});

		const changePasswordForm = document.getElementById('changePasswordForm');
		const passwordError = document.getElementById('passwordError');
		const passwordSuccess = document.getElementById('passwordSuccess');

		changePasswordForm.addEventListener('submit', async (e) => {
			e.preventDefault();
			passwordError.style.display = 'none';
			passwordSuccess.style.display = 'none';

			const currentPassword = document.getElementById('currentPassword').value;
			const newPassword = document.getElementById('newPassword').value;
			const confirmPassword = document.getElementById('confirmPassword').value;

			if(newPassword !== confirmPassword){
				passwordError.textContent = 'New passwords do not match';
				passwordError.style.display = 'block';
				return;
			}

			if(newPassword.length < 8){
				passwordError.textContent = 'Password must be at least 8 characters';
				passwordError.style.display = 'block';
				return;
			}

			const submitBtn = changePasswordForm.querySelector('button[type="submit"]');
			submitBtn.disabled = true;
			submitBtn.textContent = 'Changing...';

			try {
				const response = await fetch('/kempo/api/change-password', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({ currentPassword, newPassword })
				});

				const data = await response.json();

				if(!response.ok){
					throw new Error(data.error || 'Failed to change password');
				}

				passwordSuccess.textContent = 'Password changed successfully!';
				passwordSuccess.style.display = 'block';
				changePasswordForm.reset();
				
				setTimeout(() => {
					changePasswordDialog.close();
					passwordSuccess.style.display = 'none';
				}, 2000);
			} catch(error){
				passwordError.textContent = error.message;
				passwordError.style.display = 'block';
			} finally {
				submitBtn.disabled = false;
				submitBtn.textContent = 'Change Password';
			}
		});

		logoutBtn.addEventListener('click', async () => {
			try {
				await logout();
				window.location.href = '/';
			} catch(error) {
				console.error('Logout failed:', error);
			}
		});

		loadAccount();
	</script>
</body>
</html>
