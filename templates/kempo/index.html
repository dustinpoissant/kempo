<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="icon" type="image/png" sizes="48x48" href="../media/icon48.png">
	<link rel="manifest" href="../manifest.json" />
	<title>Admin Dashboard</title>
	<link rel="stylesheet" href="../kempo-css/kempo.min.css">
	<script>window.litDisableBundleWarning = true;</script>
</head>
<body>
	<nav class="p bg-dark c-light">
		<div class="flex jc-sb ai-c">
			<h5>CMS Admin</h5>
			<div>
				<span class="mr" id="userName">Loading...</span>
				<a href="/account" class="c-light mr">Account</a>
				<button id="logoutBtn" class="p-sm br bg-danger c-light">Logout</button>
			</div>
		</div>
	</nav>
	<main class="p">
		<div id="accessDenied" style="display: none; max-width: 600px; margin: 100px auto; text-align: center;">
			<h1>Access Denied</h1>
			<p>You do not have permission to access the admin panel.</p>
			<p id="roleInfo"></p>
			<a href="/account" class="p-sm br d-ib mt">Back to Account</a>
		</div>

		<div id="dashboard">
			<h2>Admin Dashboard</h2>
			<p>Welcome to the admin panel, <span id="welcomeName"></span>!</p>
			
			<div class="mt">
				<strong>Your Role:</strong> <span id="userRole" class="p-sm br bg-info c-white"></span>
			</div>
			
			<div class="mt-lg">
				<h3>Quick Actions</h3>
				<div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
					<div class="p br shadow">
						<h4>Content</h4>
						<p>Manage your content</p>
						<a href="/kempo/content" class="p-sm br d-ib mt">View Content</a>
					</div>
					<div class="p br shadow">
						<h4>Pages</h4>
						<p>Manage your pages</p>
						<a href="/kempo/pages" class="p-sm br d-ib mt">View Pages</a>
					</div>
					<div class="p br shadow">
						<h4>Media</h4>
						<p>Manage media files</p>
						<a href="/kempo/media" class="p-sm br d-ib mt">View Media</a>
					</div>
					<div class="p br shadow" id="usersCard" style="display: none;">
						<h4>Users</h4>
						<p>Manage users & roles</p>
						<a href="/kempo/users" class="p-sm br d-ib mt">View Users</a>
					</div>
					<div class="p br shadow" id="settingsCard" style="display: none;">
						<h4>Settings</h4>
						<p>Configure your site</p>
						<a href="/kempo/settings" class="p-sm br d-ib mt">Settings</a>
					</div>
				</div>
			</div>

			<div class="mt-lg" id="membersList" style="display: none;">
				<h3>Site Members</h3>
				<div id="membersContainer"></div>
			</div>
		</div>
	</main>

	<script type="module">
		import { getSession, getActiveMemberRole, hasPermission, listMembers, logout } from '../kempo/auth.js';

		const dashboard = document.getElementById('dashboard');
		const accessDenied = document.getElementById('accessDenied');
		const userNameEl = document.getElementById('userName');
		const welcomeNameEl = document.getElementById('welcomeName');
		const userRoleEl = document.getElementById('userRole');
		const roleInfoEl = document.getElementById('roleInfo');
		const logoutBtn = document.getElementById('logoutBtn');
		const usersCard = document.getElementById('usersCard');
		const settingsCard = document.getElementById('settingsCard');
		const membersList = document.getElementById('membersList');
		const membersContainer = document.getElementById('membersContainer');

		async function loadDashboard() {
			try {
				const session = await getSession();
				
				if(!session || !session.user) {
					window.location.href = '/account/login';
					return;
				}

				userNameEl.textContent = session.user.name;
				welcomeNameEl.textContent = session.user.name;

				const roleData = await getActiveMemberRole();
				userRoleEl.textContent = roleData.role;
				
				const canReadUsers = await hasPermission({ user: ['read'] });
				if(canReadUsers) {
					usersCard.style.display = 'block';
					await loadMembers();
				}

				const canReadSettings = await hasPermission({ settings: ['read'] });
				if(canReadSettings) {
					settingsCard.style.display = 'block';
				}

			} catch(error) {
				console.error('Dashboard error:', error);
				dashboard.style.display = 'none';
				accessDenied.style.display = 'block';
				roleInfoEl.textContent = 'You need at least contributor access to view the admin panel.';
			}
		}

		async function loadMembers() {
			try {
				const data = await listMembers({ limit: 10 });
				if(data.members && data.members.length > 0) {
					membersList.style.display = 'block';
					membersContainer.innerHTML = data.members.map(member => `
						<div class="p br shadow mb">
							<div class="flex jc-sb ai-c">
								<div>
									<strong>${member.user.name}</strong>
									<span class="ml-sm p-sm br bg-info c-white">${member.role}</span>
								</div>
								<small>${member.user.email}</small>
							</div>
						</div>
					`).join('');
				}
			} catch(error) {
				console.error('Failed to load members:', error);
			}
		}

		logoutBtn.addEventListener('click', async () => {
			try {
				await logout();
				window.location.href = '/';
			} catch(error) {
				console.error('Logout failed:', error);
			}
		});

		loadDashboard();
	</script>
</body>
</html>
